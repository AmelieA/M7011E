<!DOCTYPE html>
<html>
<head>
<meta charset=utf-8 />
<title>VISA</title>
  
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' />
  <script type="text/javascript" src='http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js'></script>
  <script type="text/javascript" src="/javascripts/l.control.geosearch.js"></script>
  <script type="text/javascript" src="/javascripts/l.geosearch.provider.openstreetmap.js"></script>
  <script src="/javascripts/jquery.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.imagesloaded.min.js" type="text/javascript"></script>
  <script src="/javascripts/jQueryRotate.min.js" type="text/javascript"></script>
  <script src="/javascripts/jquery.heapshot.js" type="text/javascript"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script src="/javascripts/bigSlide.js"></script>
  <script type="text/javascript" src="/socket.io/socket.io.js"></script>
  <noscript>Sorry, your browser does not support JavaScript !</noscript>
  <link href='/stylesheets/mapbox.css' rel='stylesheet' />
<!--
  <link rel="stylesheet" href="/stylesheets/bootstrap.min.css" media="screen">
-->
  <link rel="shortcut icon" href="/images/VISA-favicon.ico" >
  
</head>
<body>
	<form id="menu" class="panel" role="navigation">
        <ul id="ulAd" style="">
			<li><input type="text" name="name" value="name of the place" style="color:#888;" onfocus="inputFocus(this)" onblur="inputBlur(this)" ><br></li>
			<li><textarea id=comment name="comment" cols="19" rows="7" style="color:#888;" onfocus="inputFocus(this)" onblur="inputBlur(this)" >comments</textarea></li>
			<li><font size="2"><font color="white">location :</font></font></li>
			<input id="locationHiddenX" type="hidden" name="x" value="null" />
			<input id="locationHiddenY" type="hidden" name="y" value="null" />
			<input id="loginHidden" type="hidden" name="login" value="null" />
			<li><p id="location"><font size="1"><font color="white">select the location by clicking on the map</p></font></font></li>
			<li><input type="submit" value="add" style="width: 176px;"></li>
		</ul>
		<ul id="ul" style="display:none" scrolling="yes">
			<li><p id="NamePlace"><font color="white">Name</p></font></li>
			<div id="comments" class="comments"></div>
		</ul>
		<ul>
			<li><p id="userName" style="position:absolute; bottom:1%;" ><font size="1"><font color="white"></p></font></font></li>
			<li><a id="google" style="position:absolute; bottom:0;" href="/auth/google">Sign In with Google</a></li>
        </ul>
    </form>
		

    <script>
		function inputFocus(i){
			if(i.value==i.defaultValue){ i.value=""; i.style.color="#000"; }
		}
		function inputBlur(i){
			if(i.value==""){ i.value=i.defaultValue; i.style.color="#888"; }
		}
    </script>
<a href="menu" class="menu-link"><img src="/images/tab-nav.png" alt="some_text"></a>
<div id='map'></div>



	<script>
	/*    BigSlide   */
	$(document).ready(function() {
		menu = $('.menu-link').bigSlide();
	});
	
	/*   leaflet   */
	var map = L.map('map', {zoomControl: false}).setView([65, 22], 3);
	map.addControl( L.control.zoom({position: 'topright'}) )
	L.tileLayer('http://{s}.tile.cloudmade.com/9d9033e8b1eb4c99a678bca933620e84/997/256/{z}/{x}/{y}.png', {
		attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>',
		maxZoom: 18
	}).addTo(map);
	new L.Control.GeoSearch({
		provider: new L.GeoSearch.Provider.OpenStreetMap(),
	}).addTo(map)
	function onMapClick(e) {
		document.getElementById("location").innerHTML=e.latlng.lat+","+e.latlng.lng;
		document.getElementById("location").setAttribute("style", "font-size: 12px;");
		document.getElementById("locationHiddenX").value=e.latlng.lat;
		document.getElementById("locationHiddenY").value=e.latlng.lng;
		document.getElementById("ulAd").style.display = "";
		document.getElementById("ul").style.display = "none";
		menu.open();
		//~ marker = L.marker([e.latlng.lat, e.latlng.lng], {draggable:true}).addTo(map);
	}
	map.on('click', onMapClick);
	
	
	/*   login part   */
	var pathArray = window.location.pathname.split( '/' );
	var UserName = decodeURI(pathArray[2]);
	//~ alert(UserName);
	if ((UserName != 'undefined') && (UserName != "")){
		//~ alert("if");
		document.getElementById("userName").innerHTML= "wellcome "+UserName;
		document.getElementById("loginHidden").value=UserName;
		document.getElementById("google").innerHTML = "log out";
		document.getElementById("google").href = '/logout';
	}
	else{
		//~ alert("else");
		document.getElementById("userName").innerHTML= "";
		document.getElementById("google").innerHTML = "Sign In with Google";
		document.getElementById("google").href = "/auth/google";
	}
	
	/*---PIN display---*/
    window.socket = io.connect();
    markers = null;
    socket.on('display', function (result) {
	
		for (var i = 0; i < result.rows.length; i++) {
			marker = L.marker([result.rows[i].x, result.rows[i].y]).addTo(map);
			marker.on('click', markerClick);
			}
		window.db = result;

    });
	
	var oldMarker;
	function markerClick(e) {
		if (document.getElementById("ulAd").style.display == ""){ //if you can "see" the ad menu
			menu.close();
			showComment(e.latlng.lat,e.latlng.lng);
			setTimeout(function(){
				document.getElementById("ul").style.display = "";
				document.getElementById("ulAd").style.display = "none";
				menu.open();
			}, 300);
		}
		else if((menu.state == "open") && (oldMarker == this.getLatLng())){
			menu.close();
		}else if ((menu.state == "open") && (oldMarker != this.getLatLng())){
			menu.close();
			showComment(e.latlng.lat,e.latlng.lng);
			setTimeout(function(){
				menu.open();
			}, 300);
		}else if ((menu.state == "closed")){
			showComment(e.latlng.lat,e.latlng.lng);
			setTimeout(function(){
				menu.open();
			}, 300);
		}
		oldMarker = this.getLatLng();
	}
	
	function showComment(x,y){
		var LocationName;
		for (var i = 0; i < window.db.rows.length; i++) { //look for the right collom
			if((window.db.rows[i].x == x)&&(window.db.rows[i].y == y)){
				LocationName = window.db.rows[i].location;
			}
		}
		
		document.getElementById("NamePlace").innerHTML = LocationName ;
		document.getElementById("NamePlace").setAttribute("style", "color:white;");
		$('#comments').empty();
		var node = document.getElementById("comments");
		socket.emit('AskForComment', { location: LocationName });
		socket.on('displayComments', function (result) { //select and put the good comments
			for (var i = 0; i < result.rows.length; i++) {
				node.innerHTML += "<p class=\"user\">from "+result.rows[i].login+ "</p>";
				node.innerHTML += "<p class=\"comment\"> "+result.rows[i].text+ "</p>";
			}
		});
        //~ node.innerHTML += "<p class=\"user\">" + "from Amélie on the 28\/11\/13" + "</p>";
        //~ node.innerHTML += "<p class=\"comment\">" + "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" + "</p>";
		//~ node.innerHTML += "<p class=\"user\">" + "from Amélie on the 27\/11\/13" + "</p>";
        //~ node.innerHTML += "<p class=\"comment\">" + "bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb" + "</p>";
		}
	
	</script>
	
	<script type="text/javascript">
    
    </script>
	
	
</body>
</html>
